generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ─── Enums ──────────────────────────────────────────────────────────────────

enum UserRole {
  ROOT // Toàn quyền hệ thống
  ADMIN     // Quản trị toàn hệ thống
  STAFF     // Nhân viên
  ORGANIZER // Tổ chức
  CREATOR   // Nhà sáng tạo
  PARTNER   // Đối tác
  PLAYER    // Tuyển thủ (được claim profile)
  USER      // Fan, đánh giá, minigame
}

enum UserStatus {
  ACTIVE
  UNACTIVE
  BAN
  LOCK
}

enum TournamentStatus {
  upcoming
  ongoing
  completed
  cancelled
}

enum MatchStatus {
  scheduled
  live
  completed
  cancelled
}

enum PlayerTier {
  S
  A
  B
  C
  D
  F
}

enum TeamMemberRole {
  player
  captain
  coach
  substitute
}

// ─── Information System ───────────────────────────────────────────────────────

enum OrganizationType {
  ORGANIZER // Đơn vị tổ chức
  SPONSOR   // Nhà tài trợ
  CLUB      // Chủ quản đội tuyển
  AGENCY    // Đại diện/Môi giới
}

// ─── Models ─────────────────────────────────────────────────────────────────
// USER MODELS

model User {
  id               String     @id @default(uuid())
  email            String     @unique
  password         String
  username         String     @unique
  name             String?
  accountType      Int        @default(1) // 0: admin, 1: user
  role             UserRole[] @default([USER])
  status           UserStatus @default(ACTIVE)
  avatar           String?
  ggId             String?
  bio              String?
  suspendedAt      DateTime?
  suspendedUntil   DateTime?
  suspensionReason String?
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  players              Player[]
  ratings              Rating[]
  organizedTournaments Tournament[]
  refereedMatches      Match[]
  permission           UserPermission?
  ownedOrganizations   Organization[] @relation("OrgOwner")
  managedOrganizations Organization[] @relation("OrgManager")

  @@map("users")
}

// ─── Permission System ───────────────────────────────────────────────────────

model GroupPermission {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  isSystem    Boolean  @default(false)
  isActive    Boolean  @default(true)
  permissions String[] @default([])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  userGroups UserGroupPermission[]

  @@map("group_permissions")
}

model UserPermission {
  id                    String   @id @default(uuid())
  userId                String   @unique
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  cachedCodes           String[] @default([])
  additionalPermissions String[] @default([])
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  groups UserGroupPermission[]

  @@map("user_permissions")
}

model UserGroupPermission {
  id                String          @id @default(uuid())
  userId            String
  userPermission    UserPermission  @relation(fields: [userId], references: [userId], onDelete: Cascade)
  groupPermissionId String
  groupPermission   GroupPermission @relation(fields: [groupPermissionId], references: [id], onDelete: Cascade)
  createdAt         DateTime        @default(now())

  @@unique([userId, groupPermissionId])
  @@index([userId])
  @@index([groupPermissionId])
  @@map("user_group_permissions")
}

// ─── Information System Models ────────────────────────────────────────────────

model Region {
  id        String   @id @default(uuid())
  name      String   @unique
  code      String   @unique
  logo      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  teams         Team[]
  organizations Organization[]

  @@map("regions")
}

model Organization {
  id          String             @id @default(uuid())
  name        String             @unique
  shortName   String?
  logo        String?
  website     String?
  description String?
  mediaLinks  Json               @default("[]")
  roles       OrganizationType[]

  ownerId   String
  owner     User    @relation("OrgOwner", fields: [ownerId], references: [id])
  managerId String?
  manager   User?   @relation("OrgManager", fields: [managerId], references: [id])

  regionId String?
  region   Region? @relation(fields: [regionId], references: [id])

  teams            Team[]
  tournaments      Tournament[] @relation("OrgTournaments")
  sponsoredMatches Match[]      @relation("OrgSponsoredMatches")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([regionId])
  @@index([ownerId])
  @@map("organizations")
}

model Game {
  id        String   @id @default(uuid())
  name      String   @unique
  shortName String
  iconUrl   String   @default("")
  roles     String[] @default([])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  players     Player[]
  tournaments Tournament[]

  @@map("games")
}

model Team {
  id        String   @id @default(uuid())
  slug      String   @unique
  name      String   @unique
  tag       String?
  logoUrl   String?
  regionTag String?  @map("region") // legacy string field — use regionId FK for new code
  wins      Int      @default(0)
  losses    Int      @default(0)
  draws     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  regionId       String?
  region         Region?       @relation(fields: [regionId], references: [id], onDelete: SetNull)

  players         Player[]
  members         TeamMember[]
  tournamentTeams TournamentTeam[]
  matchesAsTeam1  Match[]          @relation("MatchTeam1")
  matchesAsTeam2  Match[]          @relation("MatchTeam2")
  matchesWon      Match[]          @relation("MatchWinner")
  matchEvents     MatchEvent[]

  @@index([organizationId])
  @@index([regionId])
  @@map("teams")
}

model Player {
  id           String     @id @default(uuid())
  slug         String     @unique
  displayName  String
  realName     String?
  nationality  String?
  imageUrl     String     @default("")
  bannerUrl    String?
  role         String?
  rating       Float      @default(0)
  aim          Int        @default(0) @db.SmallInt
  gameIq       Int        @default(0) @db.SmallInt
  clutch       Int        @default(0) @db.SmallInt
  teamplay     Int        @default(0) @db.SmallInt
  consistency  Int        @default(0) @db.SmallInt
  totalRatings Int        @default(0)
  tier         PlayerTier @default(F)
  rank         Int        @default(0)
  isActive     Boolean    @default(true)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)
  gameId String
  game   Game    @relation(fields: [gameId], references: [id])
  teamId String?
  team   Team?   @relation(fields: [teamId], references: [id], onDelete: SetNull)

  teamMembers TeamMember[]
  ratings     Rating[]
  matchEvents MatchEvent[]

  @@index([rating(sort: Desc)])
  @@index([tier])
  @@index([gameId])
  @@index([teamId])
  @@map("players")
}

model TeamMember {
  id       String         @id @default(uuid())
  role     TeamMemberRole @default(player)
  joinedAt DateTime       @default(now())
  leftAt   DateTime?

  teamId   String
  team     Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)
  playerId String
  player   Player @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([teamId, playerId, leftAt])
  @@index([teamId])
  @@index([playerId])
  @@map("team_members")
}

model Rating {
  id          String   @id @default(uuid())
  overall     Float
  aim         Int?     @db.SmallInt
  gameIq      Int?     @db.SmallInt
  clutch      Int?     @db.SmallInt
  teamplay    Int?     @db.SmallInt
  consistency Int?     @db.SmallInt
  comment     String   @default("")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  playerId String
  player   Player @relation(fields: [playerId], references: [id], onDelete: Cascade)
  userId   String?
  user     User?  @relation(fields: [userId], references: [id], onDelete: SetNull)

  // For anonymous ratings (from mock data)
  userName   String?
  userAvatar String?

  @@index([playerId])
  @@index([userId])
  @@map("ratings")
}

model Tournament {
  id          String           @id @default(uuid())
  slug        String           @unique
  name        String
  description String?
  startDate   DateTime
  endDate     DateTime
  status      TournamentStatus @default(upcoming)
  prizePool   Float            @default(0)
  rules       String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  gameId      String
  game        Game   @relation(fields: [gameId], references: [id])
  organizerId String
  organizer   User   @relation(fields: [organizerId], references: [id])

  organizationId String?
  organization   Organization? @relation("OrgTournaments", fields: [organizationId], references: [id], onDelete: SetNull)

  tournamentTeams TournamentTeam[]
  matches         Match[]

  @@index([status])
  @@index([gameId])
  @@index([startDate])
  @@index([organizationId])
  @@map("tournaments")
}

model TournamentTeam {
  id        String @id @default(uuid())
  seed      Int?
  placement Int?

  tournamentId String
  tournament   Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  teamId       String
  team         Team       @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([tournamentId, teamId])
  @@map("tournament_teams")
}

model Match {
  id            String      @id @default(uuid())
  scheduledTime DateTime
  status        MatchStatus @default(scheduled)
  scoreTeam1    Int?
  scoreTeam2    Int?
  duration      Int?
  streamUrl     String?
  round         Int?
  bracketPos    Int?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  tournamentId String
  tournament   Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  team1Id      String?
  team1        Team?      @relation("MatchTeam1", fields: [team1Id], references: [id])
  team2Id      String?
  team2        Team?      @relation("MatchTeam2", fields: [team2Id], references: [id])
  winnerId     String?
  winner       Team?      @relation("MatchWinner", fields: [winnerId], references: [id])
  refereeId    String?
  referee      User?      @relation(fields: [refereeId], references: [id])
  nextMatchId  String?
  nextMatch    Match?     @relation("BracketProgression", fields: [nextMatchId], references: [id])
  prevMatches  Match[]    @relation("BracketProgression")

  sponsorId String?
  sponsor   Organization? @relation("OrgSponsoredMatches", fields: [sponsorId], references: [id], onDelete: SetNull)

  matchEvents MatchEvent[]

  @@index([tournamentId])
  @@index([status])
  @@index([scheduledTime])
  @@index([sponsorId])
  @@map("matches")
}

model MatchEvent {
  id        String   @id @default(uuid())
  type      String
  timestamp DateTime @default(now())
  data      Json     @default("{}")

  matchId  String
  match    Match   @relation(fields: [matchId], references: [id], onDelete: Cascade)
  teamId   String?
  team     Team?   @relation(fields: [teamId], references: [id])
  playerId String?
  player   Player? @relation(fields: [playerId], references: [id])

  @@index([matchId])
  @@index([type])
  @@map("match_events")
}
